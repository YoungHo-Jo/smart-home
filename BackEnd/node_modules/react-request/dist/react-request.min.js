!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react")):"function"==typeof define&&define.amd?define(["exports","react"],t):t(e.ReactRequest={},e.React)}(this,function(e,t){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var r={};function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.url,r=e.method,n=e.responseType,o=void 0===n?"":n,s=e.body,i=void 0===s?"":s;return[void 0===t?"":t,(void 0===r?"":r).toUpperCase(),o,i].join("||")}function o(e){return!!r[e]}function s(e){var t=e.requestKey,n=e.res,o=e.err;(r[t]||[]).forEach(function(e){n?e.resolve(n):e.reject(o)}),r[t]=null}function i(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments[2],i=void 0,u=void 0;o?(i=o,u=t):t.responseType?(i=t,u={}):(i={},u=t);var a=i.responseType,c=void 0===a?"":a,p=i.dedupe,f=void 0===p||p,l=i.requestKey||n({url:e.url||e,method:u.method||e.method||"",body:u.body||e.body||""}),d=void 0;if(f){r[l]||(r[l]=[]);var h=r[l],y=!!h.length,v={};if(d=new Promise(function(e,t){v.resolve=e,v.reject=t}),h.push(v),y)return d}var m=fetch(e,u).then(function(e){var t=void 0;return t=c instanceof Function?c(e):c||(204===e.status?"text":"json"),e[t]().then(function(t){if(e.data=t,!f)return e;s({requestKey:l,res:e})},function(){if(e.data=null,!f)return e;s({requestKey:l,res:e})})},function(e){if(!f)return Promise.reject(e);s({requestKey:l,err:e})});return f?d:m}var u=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},a=function(){function e(e,t){for(var r=0;t.length>r;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),c=Object.assign||function(e){for(var t=1;arguments.length>t;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},p=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},f={};var l=function(e){function r(e,t){u(this,r);var s=p(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e,t));return s.isReadRequest=function(e){var t=e.toUpperCase();return"GET"===t||"HEAD"===t||"OPTIONS"===t},s.isLazy=function(){var e=s.props,t=e.lazy;return void 0===t?!s.isReadRequest(e.method):t},s.shouldCacheResponse=function(){var e=s.props,t=e.cacheResponse;return void 0===t?s.isReadRequest(e.method):t},s.getFetchPolicy=function(){var e=s.props,t=e.fetchPolicy;return void 0===t?s.isReadRequest(e.method)?"cache-first":"network-only":t},s.cancelExistingRequest=function(e){if(s.state.fetching&&null!==s._currentRequestKey){var t=Error(e);t.name="AbortError",s.onResponseReceived(c({},s.responseReceivedInfo,{error:t,hittingNetwork:!0}))}},s.fetchRenderProp=function(e){return new Promise(function(t){setTimeout(function(){s.fetchData(e,!0,t)})})},s.getRequestKey=function(e){if(e&&e.requestKey)return e.requestKey;if(e){var t=Object.assign({},s.props,e);return n({url:t.url,body:t.body,method:t.method.toUpperCase()})}if(s.props.requestKey)return s.props.requestKey;var r=s.props;return n({url:r.url,body:r.body,method:r.method.toUpperCase()})},s.fetchData=function(e,t,r){var n=s.props,u=n.requestName,a=n.dedupe,p=n.beforeFetch;s.cancelExistingRequest("New fetch initiated");var l=s.getRequestKey(e),d=Object.assign({},s.props,e);s._currentRequestKey=l;var h=d.url,y=d.body,v=d.credentials,m=d.headers,R=d.responseType,q=d.mode,g=d.cache,b=d.redirect,K=d.referrer,w=d.referrerPolicy,P=d.integrity,k=d.keepalive,j=d.signal,O=d.method.toUpperCase(),C=s.shouldCacheResponse(),_={body:y,credentials:v,headers:m,method:O,mode:q,cache:g,redirect:b,referrer:K,referrerPolicy:w,integrity:P,keepalive:k,signal:j},N={url:h,init:_,requestKey:l,responseType:R};s.responseReceivedInfo=N;var U=s.getFetchPolicy(),E=void 0;if("network-only"!==U&&!t)if(E=f[l]){if(s.onResponseReceived(c({},N,{response:E,hittingNetwork:!1,stillFetching:"cache-and-network"===U})),"cache-first"===U||"cache-only"===U)return Promise.resolve(E)}else if("cache-only"===U){var F=Error('Response for "'+u+'" not found in cache.');return s.onResponseReceived(c({},N,{error:F,hittingNetwork:!1})),Promise.resolve(F)}s.setState({requestKey:l,url:h,error:null,failed:!1,fetching:!0});var T=!o(l)||!a;return T&&p({url:h,init:_,requestKey:l}),i(h,_,{requestKey:l,responseType:R,dedupe:a}).then(function(e){return C&&(f[l]=e),s._currentRequestKey===l&&s.onResponseReceived(c({},N,{response:e,hittingNetwork:T,resolve:r})),e},function(e){return s._currentRequestKey===l&&s.onResponseReceived(c({},N,{error:e,cachedResponse:E,hittingNetwork:T,resolve:r})),e})},s.onResponseReceived=function(e){var t=e.error,r=void 0===t?null:t,n=e.response,o=void 0===n?null:n,i=e.hittingNetwork,u=e.url,a=e.init,c=e.requestKey,p=e.cachedResponse,f=e.stillFetching,l=void 0!==f&&f,d=e.resolve;s.responseReceivedInfo=null,l||(s._currentRequestKey=null);var h=void 0;o&&o.data?h=o.data:p&&p.data&&(h=p.data),h=h?s.props.transformData(h):null,r&&s.state.data&&(h=s.state.data);var y={url:u,init:a,requestKey:c,error:r,failed:!!(r||o&&!o.ok),response:o,data:h,didUnmount:!!s.willUnmount};"function"==typeof d&&d(y),i&&s.props.afterFetch(y),s.willUnmount||s.setState({url:u,data:h,error:r,response:o,fetching:l,requestKey:c},function(){return s.props.onResponse(r,o)})},s.state={requestKey:e.requestKey||n(c({},e,{method:e.method.toUpperCase()})),requestName:e.requestName,fetching:!1,response:null,data:null,error:null,url:e.url},s}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(r,t.Component),a(r,[{key:"render",value:function(){var e=this.props,t=e.children,r=this.state,n=r.response,o=r.error;return t&&t({requestName:e.requestName,url:r.url,fetching:r.fetching,failed:!!(o||n&&!n.ok),response:n,data:r.data,requestKey:r.requestKey,error:o,doFetch:this.fetchRenderProp})||null}}]),a(r,[{key:"componentDidMount",value:function(){this.isLazy()||this.fetchData()}},{key:"componentDidUpdate",value:function(e){var t=this.props.requestKey||n(c({},this.props,{method:this.props.method.toUpperCase()}));t===(e.requestKey||n(c({},e,{method:e.method.toUpperCase()})))||this.isLazy()||this.fetchData({requestKey:t})}},{key:"componentWillUnmount",value:function(){this.willUnmount=!0,this.cancelExistingRequest("Component unmounted")}}]),r}();l.defaultProps={requestName:"anonymousRequest",onResponse:function(){},beforeFetch:function(){},afterFetch:function(){},transformData:function(e){return e},dedupe:!0,method:"get",referrerPolicy:"",integrity:"",referrer:"about:client"},e.Fetch=l,e.fetchDedupe=i,e.getRequestKey=n,e.isRequestInFlight=o,e.clearRequestCache=function(){r={}},e.clearResponseCache=function(){f={}},Object.defineProperty(e,"__esModule",{value:!0})});
